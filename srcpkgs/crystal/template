# Template file for 'crystal'
pkgname=crystal
version=1.2.2
revision=1
archs="x86_64"
short_desc="The Crystal Programming Language"
hostmakedepends="crystal-bin llvm lld pkg-config git"
makedepends="
 libbsd-devel gmp-devel libedit-devel libevent-devel
 libxml2-devel libyaml-devel openssl-devel pcre-devel
 gc-devel"
depends="${makedepends} pkg-config"
maintainer="Tiago Carvalho <t1ago_@outlook.com>"
license="Apache v2.0"
homepage="https://crystal-lang.org"
distfiles="https://github.com/crystal-lang/crystal/archive/${version}.tar.gz"
checksum=6d963a71ef5f6c73faa272a0f81b50e9ddbf814b1ec07e557ce5c95f84d6077e

# TODO: cross compile
#
# * https://crystal-lang.org/reference/syntax_and_semantics/cross-compilation.html
#
# * make target=$(llvm-config --host-target)
# 	+ make target="x86_64-unknown-linux-gnu"

case ${XBPS_MACHINE}-${XBPS_LIBC} in
	x86_64*-glibc)
		;;
	*)
		broken="This package can only be built from a glibc x86_64 host."
		;;
esac

do_build() {
	make threads=${XBPS_MAKEJOBS} release=1
}

do_install() {
	vmkdir usr/bin
	vmkdir usr/lib/crystal/bin
	vmkdir usr/share/man/man1
	vmkdir usr/share/crystal

	cp ${FILESDIR}/crystal ${DESTDIR}/usr/bin
	vcopy .build/crystal usr/lib/crystal/bin
	vcopy man/crystal.1 usr/share/man/man1
	cp -r src ${DESTDIR}/usr/share/crystal
}

post_install() {
	vdoc README.md
	vlicense LICENSE
}
